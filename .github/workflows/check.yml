name: Check

on: [pull_request]

jobs:
  check:
    name: documents updated
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler-cache: true
    - uses: actions/setup-node@v3
      with:
        node-version: 22
    - name: Check puppeteer.api.json is updated
      run: |
        set -euo pipefail
        rm -rf puppeteer
        tag="puppeteer-core-v$(cat development/DOCS_VERSION)"
        curl -L -o /tmp/puppeteer-core.tgz "https://github.com/puppeteer/puppeteer/archive/refs/tags/${tag}.tar.gz"
        tar -xzf /tmp/puppeteer-core.tgz
        mv "puppeteer-${tag}" puppeteer
        cd puppeteer
        PUPPETEER_SKIP_DOWNLOAD=1 npm install --ignore-scripts
        cd packages/puppeteer-core
        npm run build:docs
        cd ../../../
        cp puppeteer/docs/puppeteer-core.api.json development/puppeteer.api.json
        rm -rf puppeteer
        git diff --exit-code
    - name: Check api_coverage doc is updated
      run: |
        bundle exec ruby development/generate_api_coverage.rb
        git diff --exit-code

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.4
        bundler-cache: true
    - name: Generate RBS files
      run: bundle exec rake rbs
    - name: Validate RBS syntax
      run: rbs -I sig parse sig/**/*.rbs
    - name: Run Steep type check
      run: bundle exec steep check
